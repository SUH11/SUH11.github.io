(window.webpackJsonp=window.webpackJsonp||[]).push([[65],{410:function(t,a,s){"use strict";s.r(a);var e=s(42),r=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"http的代理服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#http的代理服务"}},[t._v("#")]),t._v(" HTTP的代理服务")]),t._v(" "),s("p",[t._v("中间人：代理")]),t._v(" "),s("ol",[s("li",[s("h4",{attrs:{id:"代理服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#代理服务"}},[t._v("#")]),t._v(" 代理服务")]),t._v(" "),s("p",[t._v("所谓的“代理服务”就是指服务本身不生产内容，而是处于中间位置转发上下游的请求和响应")]),t._v(" "),s("p",[t._v("具有双重身份：面向下游的用户时，表现为服务器，代表源服务器响应客户端的请求；而面向上游的源服务器时，又表现为客户端，代表客户端发送请求。")])]),t._v(" "),s("li",[s("h4",{attrs:{id:"代理的作用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#代理的作用"}},[t._v("#")]),t._v(" 代理的作用")]),t._v(" "),s("p",[t._v("$$\n计算机科学领域里的任何问题，都可以通过引入一个中间层来解决\n如果一个中间层解决不了问题，那就再加一个中间层\n$$\n对上：屏蔽真实客户端")])])]),t._v(" "),s("p",[t._v("对下：屏蔽真实服务器")]),t._v(" "),s("p",[t._v("(1) 负载均衡")]),t._v(" "),s("p",[t._v("​\t轮询、一致性哈希")]),t._v(" "),s("p",[t._v("(2) 健康检查：使用“心跳”等机制监控后端服务器，发现有故障就及时“踢出”集群，保证服务高可用")]),t._v(" "),s("p",[t._v("(3) 安全防护：限制 IP 地址或流量，抵御网络攻击和过载")]),t._v(" "),s("p",[t._v("(4) 加密卸载：外网SSL/TLS，内网不加密，降低成本")]),t._v(" "),s("p",[t._v("(5) 数据过滤：拦截上下行的数据，任意指定策略修改请求或者响应")]),t._v(" "),s("p",[t._v("(6) 内容缓存：暂存、复用服务器响应")]),t._v(" "),s("ol",{attrs:{start:"3"}},[s("li",[s("h4",{attrs:{id:"代理相关头字段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#代理相关头字段"}},[t._v("#")]),t._v(" 代理相关头字段")]),t._v(" "),s("ul",[s("li",[t._v("Via：标明代理的身份")]),t._v(" "),s("li",[t._v("X-Forwarded-For：追加的是请求方的 IP 地址（第一个是客户端地址）")]),t._v(" "),s("li",[t._v("X-Real-IP：客户端真实IP")])]),t._v(" "),s("p",[t._v("例子：proxy")]),t._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20200622165311712",href:"https://static001.geekbang.org/resource/image/c5/e7/c5aa6d5f82e8cc1a35772293972446e7.png"}},[s("img",{attrs:{src:"https://static001.geekbang.org/resource/image/c5/e7/c5aa6d5f82e8cc1a35772293972446e7.png",alt:"image-20200622165311712"}})])]),t._v(" "),s("p",[t._v("抓包数据：")]),t._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20200622165330311",href:"https://static001.geekbang.org/resource/image/5a/54/5a247e9e5bf66f5ac3316fddf4e2b254.png"}},[s("img",{attrs:{src:"https://static001.geekbang.org/resource/image/5a/54/5a247e9e5bf66f5ac3316fddf4e2b254.png",alt:"image-20200622165330311"}})])]),t._v(" "),s("p",[t._v("从抓包里就可以清晰地看出代理与客户端、源服务器的通信过程：")]),t._v(" "),s("ol",[s("li",[t._v("客户端 55061 先用三次握手连接到代理的 80 端口，然后发送 GET 请求；")]),t._v(" "),s("li",[t._v("代理不直接生产内容，所以就代表客户端，用 55063 端口连接到源服务器，也是三次握手；")]),t._v(" "),s("li",[t._v("代理成功连接源服务器后，发出了一个 HTTP/1.0 的 GET 请求；")]),t._v(" "),s("li",[t._v("因为 HTTP/1.0 默认是短连接，所以源服务器发送响应报文后立即用四次挥手关闭连接；")]),t._v(" "),s("li",[t._v("代理拿到响应报文后再发回给客户端，完成了一次代理服务。")])]),t._v(" "),s("blockquote",[s("p",[t._v("注：X-Forwarded-For和X-Real-IP不一定可靠")])])]),t._v(" "),s("li",[s("h4",{attrs:{id:"代理协议：the-proxy-protocol"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#代理协议：the-proxy-protocol"}},[t._v("#")]),t._v(" 代理协议：The PROXY protocol")]),t._v(" "),s("p",[t._v("由知名的代理软件 HAProxy 所定义，也是一个“事实标准”，被广泛采用")])])]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     TCP4:客户端ip地址类型 请求方地址\t应答方地址\t请求方端口\t\t应答方端口\\r\\n结束")]),t._v("\nPROXY TCP4 "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.1")]),t._v(".1.1 "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.2")]),t._v(".2.2 "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("55555")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("r"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("n\nGET / HTTP/1.1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("r"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("n\nHost: www.xxx.com"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("r"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("r"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("h3",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("ol",[s("li",[t._v("HTTP 代理就是客户端和服务器通信链路中的一个中间环节，为两端提供“代理服务”；")]),t._v(" "),s("li",[t._v("代理处于中间层，为 HTTP 处理增加了更多的灵活性，可以实现负载均衡、安全防护、数据过滤等功能；")]),t._v(" "),s("li",[t._v("代理服务器需要使用字段“Via”标记自己的身份，多个代理会形成一个列表；")]),t._v(" "),s("li",[t._v("如果想要知道客户端的真实 IP 地址，可以使用字段“X-Forwarded-For”和“X-Real-IP”；")]),t._v(" "),s("li",[t._v("专门的“代理协议”可以在不改动原始报文的情况下传递客户端的真实 IP。")])])])}),[],!1,null,null,null);a.default=r.exports}}]);