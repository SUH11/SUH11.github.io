(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{416:function(t,e,s){"use strict";s.r(e);var a=s(42),r=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"https4-tls1-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#https4-tls1-2"}},[t._v("#")]),t._v(" HTTPS4 - TLS1.2")]),t._v(" "),s("ol",[s("li",[s("h4",{attrs:{id:"https建立连接"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#https建立连接"}},[t._v("#")]),t._v(" https建立连接")]),t._v(" "),s("p",[t._v("按回车：浏览器首先要从 URI 里提取出协议名和域名")]),t._v(" "),s("blockquote",[s("p",[t._v("https：443、DNS解析 ===>得到IP地址===>三次握手")])]),t._v(" "),s("p",[t._v("http：建立连接后，浏览器会立即发送请求报文")]),t._v(" "),s("p",[t._v("https：它需要再用另外一个“握手”过程，在 TCP 上建立安全连接，之后才是收发 HTTP 报文。")])]),t._v(" "),s("li",[s("h4",{attrs:{id:"tls协议组成"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tls协议组成"}},[t._v("#")]),t._v(" TLS协议组成")]),t._v(" "),s("p",[t._v("子协议：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("记录协议")]),t._v(" "),s("ul",[s("li",[t._v("规定了 TLS 收发数据的基本单位：记录")])])]),t._v(" "),s("li",[s("strong",[t._v("警报协议")]),t._v(" "),s("ul",[s("li",[t._v("向对方发出警报信息，有点像是 HTTP 协议里的状态码")]),t._v(" "),s("li",[t._v("收到警报后另一方可以选择继续，也可以立即终止连接")])])]),t._v(" "),s("li",[s("strong",[t._v("握手协议")]),t._v(" "),s("ul",[s("li",[t._v("浏览器和服务器会在握手过程中协商 TLS 版本号、随机数、密码套件等信息，然后交换证书和密钥参数，最终双方协商得到会话密钥，用于后续的混合加密系统。")])])]),t._v(" "),s("li",[s("strong",[t._v("变更密码规范协议")]),t._v(" "),s("ul",[s("li",[t._v("它非常简单，就是一个“通知”，告诉对方，后续的数据都将使用加密保护")]),t._v(" "),s("li",[t._v("那么反过来，在它之前，数据都是明文的。")])])])]),t._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"TLS1.2握手",href:"https://static001.geekbang.org/resource/image/69/6c/69493b53f1b1d540acf886ebf021a26c.png"}},[s("img",{attrs:{src:"https://static001.geekbang.org/resource/image/69/6c/69493b53f1b1d540acf886ebf021a26c.png",alt:"TLS1.2握手"}})])]),t._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"TLS1.2握手过程详解",href:"https://static001.geekbang.org/resource/image/9c/1e/9caba6d4b527052bbe7168ed4013011e.png"}},[s("img",{attrs:{src:"https://static001.geekbang.org/resource/image/9c/1e/9caba6d4b527052bbe7168ed4013011e.png",alt:"TLS1.2握手过程详解"}})])]),t._v(" "),s("p",[t._v("client\t\t\t\t\t\t\t\tserver")]),t._v(" "),s("p",[t._v("-----------------1----------------\x3e")]),t._v(" "),s("p",[t._v("1.Client Hello ：客户端的版本号、支持的密码套件，还有一个"),s("strong",[t._v("随机数C")]),t._v("（用于后续生成会话密钥）")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Handshake Protocol: Client Hello\n    Version: TLS 1.2 (0x0303) // 1. 客户端的版本号\n    Random: 1cbf803321fd2623408dfe… // 2. 随机数\n    Cipher Suites (17 suites) // 3. 支持的密码套件\n        Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f)\n        Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (0xc030)\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("<----------------2-----------------")]),t._v(" "),s("p",[t._v("2.Server Hello："),s("strong",[t._v("随机数S，确认TLS版本号、使用的密码套件")]),t._v("（ECDHE）")]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("Handshake Protocol"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Server Hello\n    Version"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TLS")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.2")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x0303")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 版本号")]),t._v("\n    Random"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0e6320")]),t._v("f21bae50842e96… "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 随机数")]),t._v("\n    Cipher Suite"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0xc030")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 密码套件(从客户端支持的密码套件中选)")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("<----------------3-----------------")]),t._v(" "),s("p",[t._v("3.Server Key Exchange：里面是"),s("strong",[t._v("椭圆曲线的公钥")]),t._v("（Server Params），用来实现密钥交换算法，再加上自己的私钥签名认证。")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Handshake Protocol: Server Key Exchange\n    EC Diffie-Hellman Server Params\n        Curve Type: named_curve (0x03)\n        Named Curve: x25519 (0x001d)\n        Pubkey: 3b39deaf00217894e...\n        Signature Algorithm: rsa_pkcs1_sha512 (0x0601)\n        Signature: 37141adac38ea4...\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("p",[t._v("<----------------4-----------------")]),t._v(" "),s("p",[t._v("4.Server Hello Done")]),t._v(" "),s("p",[t._v("这样第一个消息往返就结束了（两个 TCP 包），结果是客户端和服务器通过明文共享了三个信息："),s("strong",[t._v("Client Random")]),t._v("、"),s("strong",[t._v("Server Random")]),t._v(" 和 "),s("strong",[t._v("Server Params")]),t._v("。")])])]),t._v(" "),s("p",[t._v("​")]),t._v(" "),s("p",[t._v("​\t\t----------------5-----------------\x3e")]),t._v(" "),s("p",[t._v("​\t\t5.Client Key Exchange: 客户端按照密码套件的要求，也生成一个椭圆曲线的公钥")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("\tHandshake Protocol: Client Key Exchange\nEC Diffie-Hellman Client Params\n    Pubkey: 8c674d0e08dc27b5eaa…\n")])])]),s("p",[t._v("​\t\t目前：server ====>客户端的公钥")]),t._v(" "),s("p",[t._v("​\t\t\t\t\tclient =====>服务端的公钥")]),t._v(" "),s("p",[t._v("​\t\t算出了："),s("strong",[t._v("Pre-Master")]),t._v("（也就是一个随机数）")]),t._v(" "),s("p",[t._v("​\t\t现在："),s("strong",[t._v("Client Random、Server Random 和 Pre-Master")])]),t._v(" "),s("p",[t._v("​")]),t._v(" "),s("p",[t._v("​\t\t----------------6-----------------\x3e")]),t._v(" "),s("p",[t._v("​\t\t6.Change Cipher Spec：之后该用会话密钥加密通信")]),t._v(" "),s("p",[t._v("​\t\t----------------7-----------------\x3e")]),t._v(" "),s("p",[t._v("​\t\t7.Finished：所有握手数据的摘要")]),t._v(" "),s("blockquote",[s("p",[t._v("服务器也是同样的操作，发“Change Cipher Spec”和“Finished”消息，双方都验证加密解密 OK，握手正式结束，后面就收发被加密的 HTTP 请求和响应了。")]),t._v(" "),s("p",[t._v("到第七步的时候客户端可以不用等服务端的Change Cipher Spec和Finished就发送请求了")])]),t._v(" "),s("p",[t._v("​\t\t----------------8-----------------\x3e")]),t._v(" "),s("p",[t._v("​\t\t8.Change Cipher Spec：之后该用会话密钥加密通信")]),t._v(" "),s("p",[t._v("​\t\t----------------9-----------------\x3e")]),t._v(" "),s("p",[t._v("​\t\t9.Finished：所有握手数据的摘要")]),t._v(" "),s("p",[t._v("​")]),t._v(" "),s("h3",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("ol",[s("li",[t._v("HTTPS 协议会先与服务器执行 TCP 握手，然后执行 TLS 握手，才能建立安全连接；")]),t._v(" "),s("li",[t._v("握手的目标是安全地交换对称密钥，需要三个随机数，第三个随机数“Pre-Master”必须加密传输，绝对不能让黑客破解；")]),t._v(" "),s("li",[t._v("“Hello”消息交换随机数，“Key Exchange”消息交换“Pre-Master”；")]),t._v(" "),s("li",[t._v("“Change Cipher Spec”之前传输的都是明文，之后都是对称密钥加密的密文。")])])])}),[],!1,null,null,null);e.default=r.exports}}]);